<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB 存储演示</title>
    <meta name="description" content="IndexedDB前端持久化演示应用，支持离线使用">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="IndexedDB Demo">
    
    <!-- PWA 支持 -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9InVybCgjZ3JhZGllbnQpIi8+CjxwYXRoIGQ9Ik05NiA0OEM3My45MDg2IDQ4IDU2IDY1LjkwODYgNTYgODhWMTQ0QzU2IDE2Ni4wOTEgNzMuOTA4NiAxODQgOTYgMTg0QzExOC4wOTEgMTg0IDEzNiAxNjYuMDkxIDEzNiAxNDRWODhDMTM2IDY1LjkwODYgMTE4LjA5MSA0OCA5NiA0OFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik05NiA2NEM4MS42NDA2IDY0IDcwIDc1LjY0MDYgNzAgOTBWMTA0QzcwIDExOC4zNTkgODEuNjQwNiAxMzAgOTYgMTMwQzExMC4zNTkgMTMwIDEyMiAxMTguMzU5IDEyMiAxMDRWOTBDMTIyIDc1LjY0MDYgMTEwLjM1OSA2NCA5NiA2NFoiIGZpbGw9IiM2NjdlZWEiLz4KPC9zdmc+">
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>🗄️ IndexedDB 前端持久化演示</h1>
            <p>验证浏览器本地数据库的存储和检索功能</p>
        </header>

        <div class="demo-section">
            <div class="control-panel">
                <h2>📝 数据操作</h2>
                
                <div class="form-group">
                    <label for="name">姓名:</label>
                    <input type="text" id="name" placeholder="请输入姓名">
                </div>
                
                <div class="form-group">
                    <label for="email">邮箱:</label>
                    <input type="email" id="email" placeholder="请输入邮箱">
                </div>
                
                <div class="form-group">
                    <label for="age">年龄:</label>
                    <input type="number" id="age" placeholder="请输入年龄">
                </div>
                
                <div class="form-group">
                    <label for="notes">备注:</label>
                    <textarea id="notes" placeholder="请输入备注信息"></textarea>
                </div>
                
                <div class="button-group">
                    <button id="addBtn" class="btn btn-primary">➕ 添加记录</button>
                    <button id="clearBtn" class="btn btn-danger">🗑️ 清空所有</button>
                    <button id="exportBtn" class="btn btn-success">📤 导出数据</button>
                    <button id="importBtn" class="btn btn-info">📥 导入数据</button>
                </div>
            </div>

            <div class="data-display">
                <h2>📊 数据展示</h2>
                <div class="stats">
                    <div class="stat-item">
                        <span class="stat-number" id="totalCount">0</span>
                        <span class="stat-label">总记录数</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="dbSize">0 KB</span>
                        <span class="stat-label">数据库大小</span>
                    </div>
                </div>
                
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="🔍 搜索记录...">
                </div>
                
                <div class="table-container">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>姓名</th>
                                <th>邮箱</th>
                                <th>年龄</th>
                                <th>备注</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- 数据将在这里动态显示 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="info-section">
            <h2>ℹ️ 功能说明</h2>
            <div class="info-grid">
                <div class="info-card">
                    <h3>💾 数据持久化</h3>
                    <p>数据存储在浏览器的IndexedDB中，关闭页面后数据仍然保留</p>
                </div>
                <div class="info-card">
                    <h3>🔍 搜索功能</h3>
                    <p>支持按姓名、邮箱或备注进行实时搜索</p>
                </div>
                <div class="info-card">
                    <h3>📤 数据导出</h3>
                    <p>可以将所有数据导出为JSON文件</p>
                </div>
                <div class="info-card">
                    <h3>📥 数据导入</h3>
                    <p>支持从JSON文件导入数据</p>
                </div>
            </div>
        </div>

        <div class="log-section">
            <h2>📋 操作日志</h2>
            <div id="logContainer" class="log-container">
                <!-- 操作日志将在这里显示 -->
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    
    <!-- PWA Service Worker 注册和状态管理 -->
    <script>
        // PWA状态管理
        class PWAManager {
            constructor() {
                this.isOnline = navigator.onLine;
                this.isInstalled = window.matchMedia('(display-mode: standalone)').matches;
                this.init();
            }
            
            init() {
                this.registerServiceWorker();
                this.setupNetworkListeners();
                this.setupInstallPrompt();
                this.showStatusIndicator();
            }
            
            // 注册Service Worker
            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('/sw.js')
                            .then((registration) => {
                                console.log('Service Worker注册成功:', registration.scope);
                                this.updateStatus('Service Worker已激活');
                            })
                            .catch((error) => {
                                console.log('Service Worker注册失败:', error);
                                this.updateStatus('Service Worker注册失败');
                            });
                    });
                }
            }
            
            // 设置网络状态监听
            setupNetworkListeners() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.updateStatus('网络已连接');
                    this.hideOfflineIndicator();
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateStatus('网络已断开，但应用仍可离线使用');
                    this.showOfflineIndicator();
                });
            }
            
            // 设置安装提示
            setupInstallPrompt() {
                let deferredPrompt;
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    this.showInstallButton(deferredPrompt);
                });
                
                // 监听应用安装完成
                window.addEventListener('appinstalled', () => {
                    this.isInstalled = true;
                    this.updateStatus('应用已安装到桌面');
                    this.hideInstallButton();
                });
            }
            
            // 显示安装按钮
            showInstallButton(deferredPrompt) {
                if (document.getElementById('pwa-install-btn')) return;
                
                const installButton = document.createElement('button');
                installButton.id = 'pwa-install-btn';
                installButton.textContent = '📱 安装应用';
                installButton.className = 'btn btn-primary';
                installButton.style.position = 'fixed';
                installButton.style.top = '20px';
                installButton.style.right = '20px';
                installButton.style.zIndex = '1000';
                installButton.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
                
                installButton.addEventListener('click', () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('用户接受了安装提示');
                                this.updateStatus('正在安装应用...');
                            }
                            deferredPrompt = null;
                            this.hideInstallButton();
                        });
                    }
                });
                
                document.body.appendChild(installButton);
            }
            
            // 隐藏安装按钮
            hideInstallButton() {
                const installButton = document.getElementById('pwa-install-btn');
                if (installButton) {
                    installButton.remove();
                }
            }
            
            // 显示离线指示器
            showOfflineIndicator() {
                if (document.getElementById('offline-indicator')) return;
                
                const indicator = document.createElement('div');
                indicator.id = 'offline-indicator';
                indicator.innerHTML = `
                    <div style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        background: #ff6b6b;
                        color: white;
                        text-align: center;
                        padding: 8px;
                        font-size: 14px;
                        z-index: 9999;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                    ">
                        📱 离线模式 - 应用仍可正常使用
                    </div>
                `;
                document.body.appendChild(indicator);
            }
            
            // 隐藏离线指示器
            hideOfflineIndicator() {
                const indicator = document.getElementById('offline-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }
            
            // 显示状态指示器
            showStatusIndicator() {
                const statusDiv = document.createElement('div');
                statusDiv.id = 'pwa-status';
                statusDiv.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 20px;
                    background: rgba(0,0,0,0.8);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 20px;
                    font-size: 12px;
                    z-index: 1000;
                    opacity: 0.8;
                    transition: opacity 0.3s;
                `;
                statusDiv.textContent = this.isOnline ? '在线' : '离线';
                document.body.appendChild(statusDiv);
                
                // 3秒后隐藏状态指示器
                setTimeout(() => {
                    statusDiv.style.opacity = '0';
                    setTimeout(() => statusDiv.remove(), 300);
                }, 3000);
            }
            
            // 更新状态
            updateStatus(message) {
                const statusDiv = document.getElementById('pwa-status');
                if (statusDiv) {
                    statusDiv.textContent = message;
                    statusDiv.style.opacity = '1';
                    
                    setTimeout(() => {
                        statusDiv.style.opacity = '0';
                        setTimeout(() => statusDiv.remove(), 300);
                    }, 2000);
                }
            }
        }
        
        // 初始化PWA管理器
        const pwaManager = new PWAManager();
    </script>
</body>
</html>
